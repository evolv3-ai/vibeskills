#!/bin/bash
# Gemini Coding Coach - Quick wrapper for Gemini CLI
# Version: 2.3.0 (Removed flash-lite, updated time estimates based on testing)
#
# Usage:
#   gemini-coach <task> [files...]
#   cat file.ts | gemini-coach <task>
#   gemini-coach quick "Quick question"
#   gemini-coach review-dir "Review prompt" /path/to/dir
#   gemini-coach project-review "Review prompt"
#   gemini-coach compare /path1 /path2
#   gemini-coach security-scan /path

# ============================================
# Configuration
# ============================================

# Model selection
# Flash: Faster, safer with directories, good for most tasks (~5-25s)
# Pro: Better reasoning, use for architecture/critical decisions (~15-30s)
DEFAULT_MODEL="${GEMINI_MODEL:-gemini-2.5-flash}"
DEFAULT_PRO_MODEL="gemini-2.5-pro"

# ============================================
# Helper Functions
# ============================================

# Show model info before execution
show_model_info() {
  local model="$1"
  local estimated_time=""

  case "$model" in
    gemini-2.5-flash)
      estimated_time="~5-25 seconds"
      ;;
    gemini-2.5-pro)
      estimated_time="~15-30 seconds"
      ;;
    *)
      estimated_time="~5-25 seconds"
      ;;
  esac

  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
  echo "Model: $model" >&2
  echo "Estimated time: $estimated_time" >&2
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
  echo "" >&2
}

# Quick question (no file context, fast)
gemini-quick() {
  local prompt="$1"
  show_model_info "$DEFAULT_MODEL"
  gemini "$prompt" --yolo -m "$DEFAULT_MODEL" 2>&1 | grep -v "^Loaded\|^YOLO\|^Data collection"
}

# Review with directory context (thorough)
# Fixed: Now uses cd /tmp to avoid CWD pollution
gemini-review() {
  local prompt="$1"
  local dir="${2:-.}"
  local model="${3:-$DEFAULT_MODEL}"

  # Resolve to absolute path
  dir=$(cd "$dir" 2>/dev/null && pwd || echo "$dir")

  if [ ! -d "$dir" ] && [ ! -f "$dir" ]; then
    echo "Error: Path not found: $dir" >&2
    return 1
  fi

  show_model_info "$model"

  # Run from /tmp to avoid including CWD in context
  (cd /tmp && gemini "$prompt" \
    --include-directories "$dir" \
    --yolo \
    -m "$model" 2>&1 | grep -v "^Loaded\|^YOLO\|^Data collection")
}

# Architecture advice (uses Pro model for better reasoning)
gemini-architect() {
  local prompt="$1"
  local dir="${2:-.}"
  gemini-review "$prompt" "$dir" "$DEFAULT_PRO_MODEL"
}

# Project review (entire codebase)
gemini-project-review() {
  local prompt="$1"
  local project_dir="${2:-.}"

  echo "Reviewing project: $project_dir" >&2
  echo "Note: This includes all files in the directory" >&2
  echo "" >&2

  gemini-review "$prompt" "$project_dir" "$DEFAULT_MODEL"
}

# Compare two directories or files
gemini-compare() {
  local path1="$1"
  local path2="$2"

  if [ -z "$path1" ] || [ -z "$path2" ]; then
    echo "Error: gemini-compare requires two paths" >&2
    echo "Usage: gemini-compare /path1 /path2" >&2
    return 1
  fi

  # Resolve to absolute paths
  if [ -d "$path1" ]; then
    path1=$(cd "$path1" && pwd)
  elif [ -f "$path1" ]; then
    path1=$(cd "$(dirname "$path1")" && pwd)/$(basename "$path1")
  fi

  if [ -d "$path2" ]; then
    path2=$(cd "$path2" && pwd)
  elif [ -f "$path2" ]; then
    path2=$(cd "$(dirname "$path2")" && pwd)/$(basename "$path2")
  fi

  if [ ! -e "$path1" ]; then
    echo "Error: Path not found: $path1" >&2
    return 1
  fi

  if [ ! -e "$path2" ]; then
    echo "Error: Path not found: $path2" >&2
    return 1
  fi

  show_model_info "$DEFAULT_MODEL"

  echo "Comparing:" >&2
  echo "  1) $path1" >&2
  echo "  2) $path2" >&2
  echo "" >&2

  # Run from /tmp to avoid CWD pollution
  (cd /tmp && gemini "[Claude Code consulting Gemini for peer review]

Task: Compare two implementations - analyze key differences in approach, pros and cons of each, which is better for different use cases, and any missing features in either

Provide direct analysis with specific comparisons. I will synthesize your findings with mine before presenting to the developer." \
    --include-directories "$path1" \
    --include-directories "$path2" \
    --yolo \
    -m "$DEFAULT_MODEL" 2>&1 | grep -v "^Loaded\|^YOLO\|^Data collection")
}

# Security scan (uses Pro model for thorough analysis)
gemini-security-scan() {
  local target="${1:-.}"

  echo "ðŸ”’ Security Scan: $target" >&2
  echo "Using gemini-2.5-pro for thorough analysis" >&2
  echo "" >&2

  gemini-review \
    "[Claude Code consulting Gemini for comprehensive security audit]

Task: Security audit - identify SQL injection vulnerabilities, XSS/CSRF risks, authentication/authorization flaws, insecure data handling, exposed secrets or credentials, insufficient input validation, missing rate limiting, insecure dependencies, and improper error handling

Provide direct analysis with file:line references, how to exploit, and how to fix. I will synthesize your findings with mine before presenting to the developer." \
    "$target" \
    "$DEFAULT_PRO_MODEL"
}

# ============================================
# Main Script
# ============================================

TASK="${1:-review}"
shift

# Handle special commands
case "$TASK" in
  # Helper function aliases
  quick)
    gemini-quick "$@"
    exit $?
    ;;

  review-dir)
    gemini-review "$@"
    exit $?
    ;;

  architect)
    gemini-architect "$@"
    exit $?
    ;;

  # Task bundles (new in v2.1.0)
  project-review)
    gemini-project-review "$@"
    exit $?
    ;;

  compare)
    gemini-compare "$@"
    exit $?
    ;;

  security-scan)
    gemini-security-scan "$@"
    exit $?
    ;;

  # Help
  help|--help|-h)
    cat << 'EOF'
Gemini Coding Coach - Get expert analysis on code

USAGE:
  gemini-coach <task> [files...]
  cat file.ts | gemini-coach <task>

HELPER FUNCTIONS:
  gemini-coach quick "question"                   Fast answer, no file context
  gemini-coach review-dir "prompt" /path          Review directory/file with context
  gemini-coach architect "question" /path         Architecture advice (uses Pro model)
  gemini-coach project-review "prompt" [/path]    Review entire project (default: current dir)
  gemini-coach compare /path1 /path2              Compare two directories or files
  gemini-coach security-scan [/path]              Security audit (uses Pro model, default: current dir)

TASKS:
  review        General code review (bugs, best practices, security)
  debug         Analyze errors and suggest fixes
  architecture  Review system design and architecture
  skill         Analyze Claude Code skill completeness
  docs          Verify documentation accuracy
  security      Security audit (SQL injection, XSS, etc.)
  performance   Performance analysis and optimization
  types         TypeScript type safety review
  quick         Quick question (no file context)
  review-dir    Review directory with full context
  architect     Architecture advice with Pro model
  project-review  Review entire project
  compare       Compare two implementations
  security-scan Security audit with Pro model
  help          Show this help message

CUSTOM PROMPTS:
  gemini-coach "Your custom prompt here" [files...]

EXAMPLES:
  # File-based review
  gemini-coach review src/App.tsx

  # Piped input
  cat error.log | gemini-coach debug

  # Directory review
  gemini-coach review-dir "Check for security issues" ./src

  # Project review
  gemini-coach project-review "Review for bugs and security issues"

  # Compare implementations
  gemini-coach compare ./src/auth-v1 ./src/auth-v2

  # Security scan
  gemini-coach security-scan ./src/api

  # Quick question
  gemini-coach quick "Best way to handle WebSockets in Cloudflare Workers?"

  # Architecture advice
  gemini-coach architect "Should I use D1 or KV for sessions?" .

ENVIRONMENT:
  GEMINI_MODEL      Model to use (default: gemini-2.5-flash)

NOTES:
  - Uses Gemini CLI 0.13.0+ features
  - Requires --yolo for directory access
  - Filters metadata for clean output
  - Shows model info before execution

MODEL SELECTION:
  - gemini-2.5-flash (default): Faster, safer with directories (~5-25s)
  - gemini-2.5-pro: Better reasoning for architecture/critical decisions (~15-30s)
  - Override: GEMINI_MODEL=gemini-2.5-pro gemini-coach ...

CHANGELOG:

v2.3.0 (2025-11-08):
  - REMOVED: gemini-2.5-flash-lite (not accessible via Gemini CLI, returns 404)
  - Updated: Time estimates based on real-world testing
  - Improved: Model selection guidance (Flash for most, Pro for critical)
  - Note: Flash and Pro can give different recommendations (both may be valid)

v2.2.0 (2025-11-08):
  - MAJOR: All prompts updated to AI-to-AI peer review format
  - Improved: Clear identity (Gemini advising Claude Code, not human)
  - Improved: Prevents chatty responses and role confusion
  - Improved: More direct, actionable analysis with file:line references
EOF
    exit 0
    ;;
esac

# Define prompts for preset tasks (Option B: AI-to-AI peer review format)
case "$TASK" in
  review)
    PROMPT="[Claude Code consulting Gemini for peer review]

Task: Code review - check for bugs, logic errors, security vulnerabilities (SQL injection, XSS, etc.), performance issues, best practice violations, type safety problems, and missing error handling

Provide direct analysis with file:line references. I will synthesize your findings with mine before presenting to the developer."
    ;;

  debug)
    PROMPT="[Claude Code consulting Gemini for peer review]

Task: Debug analysis - identify root cause (not just symptoms), explain why it's happening, suggest specific fix with code example, and how to prevent in future

Provide direct analysis with file:line references. I will synthesize your findings with mine before presenting to the developer."
    ;;

  architecture)
    PROMPT="[Claude Code consulting Gemini for peer review]

Task: Architecture advice - analyze for architectural anti-patterns, scalability concerns, maintainability issues, better alternatives, and potential technical debt

Provide direct analysis with specific, actionable recommendations and rationale. I will synthesize your findings with mine before presenting to the developer."
    ;;

  skill)
    PROMPT="[Claude Code consulting Gemini for peer review]

Task: Claude Code skill completeness check - verify API accuracy, identify documentation gaps or unclear explanations, find missing edge cases or error scenarios, check for outdated patterns or package versions, note incomplete examples, and identify type safety concerns

Provide direct analysis with file:line references. I will synthesize your findings with mine before presenting to the developer."
    ;;

  docs)
    PROMPT="[Claude Code consulting Gemini for peer review]

Task: Documentation accuracy verification - check for outdated information, incorrect patterns, missing important details, breaking changes not mentioned, and deprecated approaches still documented

Provide direct analysis with specific discrepancies. I will synthesize your findings with mine before presenting to the developer."
    ;;

  security)
    PROMPT="[Claude Code consulting Gemini for peer review]

Task: Security audit - identify SQL injection vulnerabilities, XSS/CSRF risks, authentication/authorization flaws, insecure data handling, exposed secrets or credentials, insufficient input validation, and missing rate limiting

Provide direct analysis with file:line references, how to exploit, and how to fix. I will synthesize your findings with mine before presenting to the developer."
    ;;

  performance)
    PROMPT="[Claude Code consulting Gemini for peer review]

Task: Performance analysis - identify N+1 queries, missing indexes, inefficient algorithms, memory leaks, unnecessary re-renders/computations, blocking operations, and missing caching

Provide direct analysis with specific optimizations and expected impact. I will synthesize your findings with mine before presenting to the developer."
    ;;

  types)
    PROMPT="[Claude Code consulting Gemini for peer review]

Task: TypeScript type safety review - identify any types that should be specific, missing generics, unsafe type assertions, implicit any, missing null checks, and type narrowing opportunities

Provide direct analysis with specific type improvements. I will synthesize your findings with mine before presenting to the developer."
    ;;

  *)
    # Custom prompt - wrap with AI-to-AI context
    PROMPT="[Claude Code consulting Gemini for peer review]

Task: $TASK

Provide direct analysis. I will synthesize your findings with mine before presenting to the developer."
    ;;
esac

# Show model info before execution (for file-based tasks)
if [ -t 0 ] && [ $# -gt 0 ]; then
  show_model_info "$DEFAULT_MODEL"
fi

# Execute Gemini with appropriate input method
if [ -t 0 ]; then
  # No stdin - expecting files as arguments
  if [ $# -eq 0 ]; then
    echo "Error: No input provided" >&2
    echo "" >&2
    echo "Usage:" >&2
    echo "  gemini-coach <task> [files...]" >&2
    echo "  cat file.ts | gemini-coach <task>" >&2
    echo "  gemini-coach quick \"question\"" >&2
    echo "" >&2
    echo "Run 'gemini-coach help' for more information." >&2
    exit 1
  fi

  # Read files and pass to Gemini
  cat "$@" | gemini "$PROMPT" --yolo -m "$DEFAULT_MODEL" 2>&1 | \
    grep -v "^Loaded\|^YOLO\|^Data collection"
else
  # Reading from stdin
  show_model_info "$DEFAULT_MODEL"
  gemini "$PROMPT" --yolo -m "$DEFAULT_MODEL" 2>&1 | \
    grep -v "^Loaded\|^YOLO\|^Data collection"
fi

# Check for errors
EXIT_CODE=$?
if [ $EXIT_CODE -ne 0 ]; then
  echo "" >&2
  echo "Error: Gemini CLI failed (exit code: $EXIT_CODE)" >&2
  echo "" >&2
  echo "Common issues:" >&2
  echo "  - Gemini CLI not installed or outdated: npm install -g @google/gemini-cli" >&2
  echo "  - Not authenticated: Run 'gemini' and follow auth prompts" >&2
  echo "  - Rate limit exceeded: Try again later" >&2
  echo "  - Required version: 0.13.0+ (run: gemini --version)" >&2
  exit $EXIT_CODE
fi
